<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDK - Pengelolaan Data Kepesantrenan</title>
    <meta name="description" content="Aplikasi Manajemen Data Santri dan Kitab">
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Konfigurasi Import Map untuk React & Icons via CDN -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>
    
    <!-- 3. Babel Standalone (Untuk compile JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles untuk Scrollbar & Animasi -->
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-scale-up { animation: scaleUp 0.3s ease-out; }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes bounceIn { 
            0% { opacity: 0; transform: scale(0.3) translateY(20px); }
            50% { opacity: 1; transform: scale(1.05) translateY(-5px); }
            70% { transform: scale(0.9) translateY(0); }
            100% { transform: scale(1) translateY(0); }
        }
        
        /* Safe area for bottom navigation on iPhone X+ */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased overflow-hidden">
    
    <!-- Container Utama React -->
    <div id="root"></div>

    <!-- Kode Aplikasi React -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, Users, Package, Settings, Plus, Save, Search, 
            Trash2, Edit2, CheckCircle, AlertCircle, Menu, X, BookOpen, 
            TrendingUp, Award, Wifi, WifiOff, Activity, UserPlus, Filter, XCircle, PieChart, Loader2, Info, BarChart2
        } from 'lucide-react';

        // --- Komponen UI Reusable ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all duration-300 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled = false, type = "button" }) => {
            const baseStyle = "px-4 py-2 rounded-xl font-medium transition-all duration-200 flex items-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg shadow-emerald-200",
                secondary: "bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:border-slate-300",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
                ghost: "bg-transparent text-slate-500 hover:bg-slate-100",
                success: "bg-green-100 text-green-700 border border-green-200 hover:bg-green-200",
                info: "bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-100"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                {children}
                </button>
            );
        };

        const Input = ({ label, ...props }) => (
            <div className="flex flex-col gap-1.5">
                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>
                <input 
                {...props}
                className={`w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-slate-700 ${props.readOnly ? 'bg-slate-100 cursor-not-allowed' : ''}`}
                />
            </div>
        );

        const Select = ({ label, options, ...props }) => (
            <div className="flex flex-col gap-1.5">
                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>
                <div className="relative">
                <select 
                    {...props}
                    className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-slate-700 appearance-none"
                >
                    <option value="">Pilih...</option>
                    {options.map(opt => (
                    <option key={opt} value={opt}>{opt}</option>
                    ))}
                </select>
                <div className="absolute right-3 top-3 pointer-events-none text-slate-400">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                </div>
            </div>
        );

        // --- Komponen Toast Notification ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(() => {
                    onClose();
                }, 3000); 
                return () => clearTimeout(timer);
            }, [onClose]);

            const styles = {
                success: { bg: 'bg-emerald-600', icon: CheckCircle },
                error: { bg: 'bg-red-500', icon: AlertCircle },
                info: { bg: 'bg-blue-500', icon: Info },
            };

            const Style = styles[type] || styles.info;
            const Icon = Style.icon;

            return (
                <div className={`fixed top-6 right-6 z-[100] flex items-center gap-3 px-4 py-3 rounded-xl shadow-xl text-white ${Style.bg} animate-bounce-in`}>
                    <Icon className="w-5 h-5" />
                    <span className="font-medium text-sm">{message}</span>
                    <button onClick={onClose} className="ml-2 hover:opacity-75"><X className="w-4 h-4" /></button>
                </div>
            );
        };

        // --- Helper Warna Hex untuk Diagram Lingkaran ---
        const getHexColor = (className) => {
            const map = {
                'bg-emerald-500': '#10b981',
                'bg-amber-400': '#fbbf24',
                'bg-rose-500': '#f43f5e',
                'bg-slate-400': '#94a3b8',
                'bg-slate-200': '#e2e8f0'
            };
            return map[className] || '#cbd5e1';
        };

        const ChartCard = ({ title, stats }) => {
            const totalCount = stats.reduce((a, b) => a + b.count, 0);
            let cumulativePercent = 0;
            
            const gradientParts = stats.map(stat => {
                const color = getHexColor(stat.color);
                const start = cumulativePercent;
                const exactPercent = totalCount > 0 ? (stat.count / totalCount) * 100 : 0;
                cumulativePercent += exactPercent;
                return `${color} ${start}% ${cumulativePercent}%`;
            });

            const hasData = totalCount > 0;
            const gradientStyle = hasData ? `conic-gradient(${gradientParts.join(', ')})` : '#f1f5f9';

            return (
                <Card className="p-5 flex flex-col h-full">
                    <div className="flex items-center gap-2 mb-4 pb-2 border-b border-slate-100">
                        <PieChart className="w-4 h-4 text-emerald-600" />
                        <h4 className="font-bold text-slate-800 text-sm">{title}</h4>
                    </div>
                    
                    <div className="flex flex-col items-center flex-1 justify-center">
                        <div className="relative w-32 h-32 rounded-full mb-6 shadow-inner transition-all duration-500" 
                             style={{ background: gradientStyle }}>
                             <div className="absolute inset-8 bg-white rounded-full flex items-center justify-center shadow-sm">
                                <div className="text-center">
                                    <span className="text-xs font-semibold text-slate-400 block">Total</span>
                                    <span className="text-lg font-bold text-slate-700">{totalCount}</span>
                                </div>
                             </div>
                        </div>
                        <div className="w-full space-y-2">
                            {stats.map((stat, idx) => (
                                <div key={idx} className="flex items-center justify-between text-xs">
                                    <div className="flex items-center gap-2">
                                        <div className={`w-2.5 h-2.5 rounded-full ${stat.color}`}></div>
                                        <span className="text-slate-600 font-medium truncate max-w-[100px]" title={stat.label}>{stat.label}</span>
                                    </div>
                                    <span className="text-slate-500 font-mono bg-slate-50 px-1.5 py-0.5 rounded">{stat.count} ({stat.percentage}%)</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </Card>
            );
        };

        const AverageCard = ({ title, data }) => (
            <Card className="p-5">
                <h4 className="font-bold text-slate-800 text-sm mb-4 border-b border-slate-100 pb-2">{title}</h4>
                <div className="space-y-3">
                    {data.map((item, idx) => (
                        <div key={idx} className="flex items-center justify-between">
                            <span className="text-sm text-slate-600 font-medium">{item.label}</span>
                            <div className="flex items-center gap-2">
                                <div className="w-32 h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div 
                                        className="h-full bg-emerald-500 rounded-full" 
                                        style={{ width: `${Math.min(100, (item.value / 100) * 100)}%` }} 
                                    ></div>
                                </div>
                                <span className="text-sm font-bold text-emerald-600 w-8 text-right">{item.value}</span>
                            </div>
                        </div>
                    ))}
                    {data.length === 0 && <p className="text-xs text-slate-400 italic">Tidak ada data</p>}
                </div>
            </Card>
        );

        const LoadingScreen = () => (
            <div className="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center animate-fade-in">
                <div className="w-16 h-16 bg-emerald-100 rounded-2xl flex items-center justify-center mb-4 animate-bounce">
                    <div className="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <h2 className="text-xl font-bold text-slate-800">Memuat Data...</h2>
                <p className="text-slate-500 text-sm mt-2">Mohon tunggu sebentar</p>
            </div>
        );

        // --- Main App Component ---

        function App() {
            const [view, setView] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            const [webAppUrl, setWebAppUrl] = useState('https://script.google.com/macros/s/AKfycbwTdH0n0IPEFMKrIpflNzxxwIH8vL6evXGtbefzN66X15bnJVgmOkPhmMIoWujjHiyn/exec');
            const [loading, setLoading] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('idle');
            const [initialLoadDone, setInitialLoadDone] = useState(false);
            const [notification, setNotification] = useState(null); 
            
            const [santriData, setSantriData] = useState([]);
            const [barangData, setBarangData] = useState([]);
            
            const [ownershipTab, setOwnershipTab] = useState('missing');

            const [showSantriModal, setShowSantriModal] = useState(false);
            const [showBarangModal, setShowBarangModal] = useState(false);
            const [editBarangData, setEditBarangData] = useState(null);
            const [editSantriData, setEditSantriData] = useState(null);

            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
                { id: 'santri', label: 'Data Santri', icon: Users },
                { id: 'barang', label: 'Kepemilikan', icon: BookOpen },
                { id: 'settings', label: 'Pengaturan', icon: Settings },
            ];

            const showToast = (message, type = 'success') => {
                setNotification({ message, type });
            };

            // --- Fungsi Parse Angka yang Kuat (Robust) ---
            const robustParseFloat = (val) => {
                if (val === undefined || val === null || val === '') return 0;
                if (typeof val === 'number') return val;
                // Ganti koma dengan titik, hapus karakter aneh
                const str = String(val).replace(',', '.').replace(/[^0-9.-]/g, '');
                const num = parseFloat(str);
                return isFinite(num) ? num : 0;
            };

            // --- Hitung Rata-rata per Kelompok ---
            const calculateGroupAverages = (data, groupKey) => {
                const groups = {};
                let hasData = false;
                
                data.forEach(item => {
                    // Pastikan key ada, atau masuk kategori 'Lainnya'
                    const key = item[groupKey] || 'Lainnya'; 
                    // Gunakan fungsi robustParseFloat untuk rekapitulasi
                    const val = robustParseFloat(item.rekapitulasi);
                    
                    if (!groups[key]) groups[key] = { sum: 0, count: 0 };
                    groups[key].sum += val;
                    groups[key].count += 1;
                    hasData = true;
                });

                if (!hasData) return [];

                return Object.entries(groups)
                    .map(([label, { sum, count }]) => ({ label, value: (sum / count).toFixed(1) }))
                    .sort((a, b) => b.value - a.value); // Urutkan dari nilai tertinggi
            };

            useEffect(() => {
                const savedUrl = localStorage.getItem('pdk_webapp_url');
                if (savedUrl) setWebAppUrl(savedUrl);
            }, []);

            useEffect(() => {
                if (webAppUrl) fetchData(webAppUrl, false);
            }, [webAppUrl]);

            const testConnection = async () => {
                setConnectionStatus('testing');
                try {
                    const response = await fetch(`${webAppUrl}?action=ping`);
                    if (response.ok || response.type === 'opaque') {
                        await fetchData(webAppUrl);
                        setConnectionStatus('success');
                        showToast("Koneksi Berhasil! Aplikasi terhubung.", "success");
                    } else {
                        throw new Error("Response status not OK");
                    }
                } catch (error) {
                    console.error("Connection Error:", error);
                    setConnectionStatus('error');
                    showToast("Koneksi Gagal. Cek URL Pengaturan.", "error");
                }
            };

            const fetchData = async (urlToUse, silent = false) => {
                const url = urlToUse || webAppUrl;
                if (!url) return;
                
                if(!silent) setLoading(true);
                try {
                    const response = await fetch(`${url}?action=getData`); 
                    if (!response.ok) throw new Error("Network response was not ok");
                    
                    const data = await response.json();
                    
                    if(data.santri && Array.isArray(data.santri)) setSantriData(data.santri);
                    if(data.barang && Array.isArray(data.barang)) setBarangData(data.barang);
                    
                    if(!silent) console.log("Data berhasil diambil:", data);
                } catch (error) {
                    if(!silent) console.error("Gagal mengambil data:", error);
                } finally {
                    if(!silent) setLoading(false);
                    setInitialLoadDone(true);
                }
            };

            const saveDataToSheet = async (type, data) => {
                if (!webAppUrl) {
                    showToast("URL Web App belum diatur!", "error");
                    return;
                }

                setLoading(true);
                try {
                    await fetch(webAppUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type, data })
                    });
                    
                    if(type === 'santri') {
                        const exists = santriData.some(s => s.niup === data.niup);
                        if (exists) {
                            const updated = santriData.map(s => s.niup === data.niup ? data : s);
                            setSantriData(updated);
                        } else {
                            setSantriData([...santriData, data]);
                        }
                        showToast("Berhasil Menyimpan Data Santri", "success");
                    }
                    if(type === 'barang') {
                        const filtered = barangData.filter(b => b.niup !== data.niup);
                        setBarangData([...filtered, data]);
                        showToast("Berhasil Menyimpan Data Kepemilikan", "success");
                    }
                    
                } catch (error) {
                    console.error(error);
                    showToast("Gagal menyimpan data. Cek koneksi.", "error");
                } finally {
                    setLoading(false);
                }
            };

            const getChartColor = (label) => {
                const l = label ? label.toLowerCase() : '';
                if (['ya', 'baik', 'lengkap', 'rapi', 'ada', 'berurutan'].includes(l)) return 'bg-emerald-500';
                if (['cukup'].includes(l)) return 'bg-amber-400';
                if (['tidak', 'rusak', 'kurang'].includes(l)) return 'bg-rose-500';
                return 'bg-slate-400';
            };

            const calculateAspectStats = (data, key, options) => {
                const total = data.length;
                if (total === 0) return options.map(opt => ({ label: opt, count: 0, percentage: 0, color: 'bg-slate-200' }));
                
                return options.map(opt => {
                    const count = data.filter(item => item[key] === opt).length;
                    return {
                        label: opt,
                        count: count,
                        percentage: total > 0 ? Math.round((count / total) * 100) : 0,
                        color: getChartColor(opt)
                    };
                });
            };

            const analysisAspects = [
                { key: 'kepemilikan-kitab', label: 'Kepemilikan Kitab', options: ['Ya', 'Tidak'] },
                { key: 'kelengkapan-kitab', label: 'Kelengkapan Kitab', options: ['Ya', 'Tidak'] },
                { key: 'kondisi-kitab', label: 'Kondisi Fisik', options: ['Baik', 'Cukup', 'Rusak'] },
                { key: 'makna-kitab', label: 'Kelengkapan Makna', options: ['Lengkap', 'Cukup', 'Tidak'] },
                { key: 'ketepatan-makna', label: 'Ketepatan Makna', options: ['Baik', 'Cukup', 'Kurang'] },
                { key: 'kerapian-makna', label: 'Kerapian Makna', options: ['Rapi', 'Cukup', 'Tidak'] },
                { key: 'catatan-kitab', label: 'Keberadaan Catatan', options: ['Ada', 'Tidak'] },
                { key: 'kualitas-catatan', label: 'Kualitas Catatan', options: ['Baik', 'Cukup', 'Kurang'] },
                { key: 'kerapian-catatan', label: 'Kerapian Catatan', options: ['Rapi', 'Cukup', 'Tidak'] },
                { key: 'keberlanjutan-catatan', label: 'Keberlanjutan', options: ['Berurutan', 'Tidak'] },
                { key: 'kesimpulan-akhir', label: 'Kesimpulan Akhir', options: ['Baik', 'Cukup', 'Kurang'] },
            ];

            const getMergedBarangData = () => {
                return barangData.map(barang => {
                    const santri = santriData.find(s => s.niup === barang.niup);
                    if (santri) {
                        return {
                            ...barang,
                            nama: santri.nama,
                            kamar: santri.kamar,
                            daerah: santri.daerah,
                            wilayah: santri.wilayah,
                            pendidikan: santri.pendidikan,
                            jurusan: santri.jurusan,
                            kelas: santri.kelas,
                            jenjang: santri.jenjang,
                            'majelis-pagi': santri['majelis-pagi'],
                            'majelis-sore': santri['majelis-sore'],
                            'majelis-kamis-pagi': santri['majelis-kamis-pagi'],
                            'majelis-kamis-sore': santri['majelis-kamis-sore']
                        };
                    }
                    return barang;
                });
            };

            const Dashboard = () => {
                const [showFilters, setShowFilters] = useState(false);
                const [activeFilters, setActiveFilters] = useState({
                    kamar: '', daerah: '', wilayah: '', pendidikan: '',
                    jurusan: '', kelas: '', jenjang: '', 'majelis-pagi': '', 'majelis-sore': ''
                });

                const getUniqueOptions = (key) => {
                    const values = santriData.map(item => item[key]).filter(val => val !== undefined && val !== '');
                    return [...new Set(values)].sort();
                };

                const handleFilterChange = (key, value) => {
                    setActiveFilters(prev => ({ ...prev, [key]: value }));
                };
                
                const clearFilters = () => {
                    setActiveFilters({
                        kamar: '', daerah: '', wilayah: '', pendidikan: '',
                        jurusan: '', kelas: '', jenjang: '', 'majelis-pagi': '', 'majelis-sore': ''
                    });
                };

                const filterData = (dataToFilter) => {
                    return dataToFilter.filter(item => {
                        return Object.entries(activeFilters).every(([key, value]) => {
                            if (!value) return true;
                            return String(item[key]) === String(value);
                        });
                    });
                };

                const mergedData = getMergedBarangData();
                const filteredSantri = filterData(santriData);
                const filteredBarang = filterData(mergedData);

                // --- KALKULASI RATA-RATA ---
                // Menggunakan robustParseFloat untuk memastikan angka terbaca meski ada koma atau format text
                const validScores = filteredBarang
                    .map(item => robustParseFloat(item.rekapitulasi));
                
                const overallAvg = validScores.length > 0 
                    ? (validScores.reduce((sum, val) => sum + val, 0) / validScores.length).toFixed(1)
                    : "0.0";

                const avgWilayah = calculateGroupAverages(filteredBarang, 'wilayah');
                const avgDaerah = calculateGroupAverages(filteredBarang, 'daerah');
                const avgPendidikan = calculateGroupAverages(filteredBarang, 'pendidikan');
                const avgMajelisPagi = calculateGroupAverages(filteredBarang, 'majelis-pagi');
                const avgMajelisSore = calculateGroupAverages(filteredBarang, 'majelis-sore');

                const stats = [
                    { label: "Total Santri", value: filteredSantri.length, icon: Users, color: "text-blue-600", bg: "bg-blue-50" },
                    { label: "Data Kepemilikan", value: filteredBarang.length, icon: Package, color: "text-emerald-600", bg: "bg-emerald-50" },
                    { label: "Belum Input", value: Math.max(0, filteredSantri.length - filteredBarang.length), icon: AlertCircle, color: "text-red-600", bg: "bg-red-50" },
                    { label: "Predikat Baik", value: filteredBarang.filter(b => robustParseFloat(b.rekapitulasi) >= 80).length, icon: Award, color: "text-amber-600", bg: "bg-amber-50" },
                ];

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Dashboard</h2>
                                <p className="text-slate-500">Ringkasan data kepesantrenan terkini.</p>
                            </div>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={() => setShowFilters(!showFilters)}>
                                    <Filter className="w-5 h-5"/> Filter
                                </Button>
                                <Button variant="secondary" onClick={() => fetchData(webAppUrl)} disabled={loading}>
                                    {loading ? 'Memuat...' : 'Refresh Data'}
                                </Button>
                            </div>
                        </div>

                        {showFilters && (
                            <Card className="p-4 bg-slate-50 border-emerald-100 animate-fade-in">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-2">
                                    <h4 className="font-bold text-slate-700 flex items-center gap-2"><Filter className="w-4 h-4" /> Filter Data Dashboard</h4>
                                    <button onClick={clearFilters} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                                        <XCircle className="w-3 h-3" /> Reset Filter
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                    <Select label="Kamar" value={activeFilters.kamar} onChange={(e) => handleFilterChange('kamar', e.target.value)} options={getUniqueOptions('kamar')} />
                                    <Select label="Daerah" value={activeFilters.daerah} onChange={(e) => handleFilterChange('daerah', e.target.value)} options={getUniqueOptions('daerah')} />
                                    <Select label="Wilayah" value={activeFilters.wilayah} onChange={(e) => handleFilterChange('wilayah', e.target.value)} options={getUniqueOptions('wilayah')} />
                                    <Select label="Pendidikan" value={activeFilters.pendidikan} onChange={(e) => handleFilterChange('pendidikan', e.target.value)} options={getUniqueOptions('pendidikan')} />
                                    <Select label="Jurusan" value={activeFilters.jurusan} onChange={(e) => handleFilterChange('jurusan', e.target.value)} options={getUniqueOptions('jurusan')} />
                                    <Select label="Kelas" value={activeFilters.kelas} onChange={(e) => handleFilterChange('kelas', e.target.value)} options={getUniqueOptions('kelas')} />
                                    <Select label="Jenjang" value={activeFilters.jenjang} onChange={(e) => handleFilterChange('jenjang', e.target.value)} options={getUniqueOptions('jenjang')} />
                                    <Select label="Majelis Pagi" value={activeFilters['majelis-pagi']} onChange={(e) => handleFilterChange('majelis-pagi', e.target.value)} options={getUniqueOptions('majelis-pagi')} />
                                    <Select label="Majelis Sore" value={activeFilters['majelis-sore']} onChange={(e) => handleFilterChange('majelis-sore', e.target.value)} options={getUniqueOptions('majelis-sore')} />
                                </div>
                            </Card>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            {stats.map((stat, idx) => (
                                <Card key={idx} className="p-6 flex items-center gap-4">
                                <div className={`p-4 rounded-xl ${stat.bg}`}>
                                    <stat.icon className={`w-6 h-6 ${stat.color}`} />
                                </div>
                                <div>
                                    <p className="text-sm font-medium text-slate-500">{stat.label}</p>
                                    <h3 className="text-2xl font-bold text-slate-800">{stat.value}</h3>
                                </div>
                                </Card>
                            ))}
                        </div>

                        {/* --- Statistics Rows (5 Baris sesuai permintaan) --- */}
                        
                        {/* Baris 1: Nilai Rata-rata Keseluruhan */}
                        <Card className="p-6 bg-gradient-to-br from-emerald-500 via-teal-600 to-cyan-600 text-white flex items-center justify-between shadow-xl shadow-teal-500/30 border-none relative overflow-hidden">
                            <div className="relative z-10">
                                <h3 className="text-xl font-bold text-white mb-1">Nilai Rata-rata Keseluruhan</h3>
                                <p className="text-xs text-white/80">Dihitung dari {filteredBarang.length} santri yang sudah dinilai</p>
                            </div>
                            <div className="text-6xl font-black tracking-tighter relative z-10">{overallAvg}</div>
                            
                            {/* Decorative background shapes */}
                            <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                            <div className="absolute top-0 right-1/4 w-24 h-24 bg-teal-400/20 rounded-full blur-xl"></div>
                        </Card>

                        {/* Baris 2: Rata-rata per Wilayah */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <AverageCard title="Rata-rata Nilai per Wilayah" data={avgWilayah} />
                            
                            {/* Baris 3: Rata-rata per Daerah */}
                            <AverageCard title="Rata-rata Nilai per Daerah" data={avgDaerah} />
                        </div>

                        {/* Baris 4: Rata-rata per Majelis */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <AverageCard title="Rata-rata Majelis Pagi" data={avgMajelisPagi} />
                            <AverageCard title="Rata-rata Majelis Sore" data={avgMajelisSore} />
                        </div>

                        {/* Baris 5: Rata-rata per Pendidikan */}
                        <AverageCard title="Rata-rata Nilai per Pendidikan" data={avgPendidikan} />

                        <div>
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <Activity className="w-5 h-5 text-emerald-600" />
                                Analisis Per Aspek
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {analysisAspects.map((aspect) => (
                                    <ChartCard 
                                        key={aspect.key}
                                        title={aspect.label}
                                        stats={calculateAspectStats(filteredBarang, aspect.key, aspect.options)}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const SantriForm = ({ onClose, initialData = null }) => {
                const defaultData = {
                    'niup': '', 'nama': '', 'kamar': '', 'daerah': '', 'wilayah': '', 
                    'pendidikan': '', 'jurusan': '', 'kelas': '', 'jenjang': '', 
                    'majelis-pagi': '', 'majelis-sore': '', 'majelis-kamis-pagi': '', 'majelis-kamis-sore': ''
                };

                const [formData, setFormData] = useState(defaultData);

                useEffect(() => {
                    if (initialData) {
                        setFormData(prev => ({ ...prev, ...initialData }));
                    }
                }, [initialData]);

                const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

                const handleSubmit = (e) => {
                    e.preventDefault();
                    saveDataToSheet('santri', formData);
                    onClose();
                };

                const isEditMode = !!initialData;

                return (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <Card className="w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 animate-scale-up">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-slate-800">{isEditMode ? 'Detail & Edit Data Santri' : 'Tambah Data Santri'}</h3>
                            <button onClick={onClose}><X className="text-slate-400 hover:text-slate-600" /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            <Input name="niup" label="NIUP" required onChange={handleChange} value={formData.niup} readOnly={isEditMode} />
                            <Input name="nama" label="Nama Lengkap" required onChange={handleChange} value={formData.nama} />
                            <Input name="kamar" label="Kamar" onChange={handleChange} value={formData.kamar} />
                            <Input name="daerah" label="Daerah" onChange={handleChange} value={formData.daerah} />
                            <Input name="wilayah" label="Wilayah" onChange={handleChange} value={formData.wilayah} />
                            <Input name="pendidikan" label="Pendidikan Formal" onChange={handleChange} value={formData.pendidikan} />
                            <Input name="jurusan" label="Jurusan" onChange={handleChange} value={formData.jurusan} />
                            <Input name="kelas" label="Kelas" onChange={handleChange} value={formData.kelas} />
                            <Input name="jenjang" label="Jenjang" onChange={handleChange} value={formData.jenjang} />
                            
                            <div className="col-span-full border-t border-slate-100 pt-4 mt-2">
                                <h4 className="text-sm font-bold text-emerald-600 mb-4 uppercase tracking-wide">Data Majelis</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <Input name="majelis-pagi" label="Majelis Pagi" onChange={handleChange} value={formData['majelis-pagi']} />
                                    <Input name="majelis-sore" label="Majelis Sore" onChange={handleChange} value={formData['majelis-sore']} />
                                    <Input name="majelis-kamis-pagi" label="Majelis Kamis Pagi" onChange={handleChange} value={formData['majelis-kamis-pagi']} />
                                    <Input name="majelis-kamis-sore" label="Majelis Kamis Sore" onChange={handleChange} value={formData['majelis-kamis-sore']} />
                                </div>
                            </div>

                            <div className="col-span-full flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                                <Button variant="secondary" onClick={onClose}>Batal</Button>
                                <Button type="submit" disabled={loading}>{loading ? 'Menyimpan...' : (isEditMode ? 'Simpan Perubahan' : 'Simpan Data')}</Button>
                            </div>
                        </form>
                        </Card>
                    </div>
                );
            };

            const BarangForm = ({ onClose, initialData = null }) => {
                const defaultData = {
                    'niup': '', 'nama': '', 'kamar': '', 'daerah': '', 'wilayah': '',
                    'pendidikan': '', 'jurusan': '', 'kelas': '', 'jenjang': '', 
                    'majelis-pagi': '', 'majelis-sore': '', 'majelis-kamis-pagi': '', 'majelis-kamis-sore': '',
                    'kepemilikan-kitab': 'Tidak', 'kelengkapan-kitab': 'Tidak', 'kondisi-kitab': 'Rusak', 
                    'makna-kitab': 'Tidak', 'ketepatan-makna': 'Kurang', 'kerapian-makna': 'Tidak',
                    'catatan-kitab': 'Tidak', 'kualitas-catatan': 'Kurang', 'kerapian-catatan': 'Tidak',
                    'keberlanjutan-catatan': 'Tidak', 'kesimpulan-akhir': 'Kurang', 'keterangan': '', 'rekapitulasi': 0
                };

                const [formData, setFormData] = useState(defaultData);

                useEffect(() => {
                    if (initialData) {
                        setFormData(prev => ({ ...prev, ...initialData }));
                    }
                }, [initialData]);

                useEffect(() => {
                    let score = 0;
                    if (formData['kepemilikan-kitab'] === 'Ya') score += 10;
                    if (formData['kelengkapan-kitab'] === 'Ya') score += 10;
                    if (formData['kondisi-kitab'] === 'Baik') score += 10; else if (formData['kondisi-kitab'] === 'Cukup') score += 5;
                    if (formData['makna-kitab'] === 'Lengkap') score += 10; else if (formData['makna-kitab'] === 'Cukup') score += 5;
                    if (formData['ketepatan-makna'] === 'Baik') score += 10; else if (formData['ketepatan-makna'] === 'Cukup') score += 5;
                    if (formData['kerapian-makna'] === 'Rapi') score += 10; else if (formData['kerapian-makna'] === 'Cukup') score += 5;
                    if (formData['catatan-kitab'] === 'Ada') score += 10;
                    if (formData['kualitas-catatan'] === 'Baik') score += 10; else if (formData['kualitas-catatan'] === 'Cukup') score += 5;
                    if (formData['kerapian-catatan'] === 'Rapi') score += 5; else if (formData['kerapian-catatan'] === 'Cukup') score += 2.5;
                    if (formData['keberlanjutan-catatan'] === 'Berurutan') score += 5;
                    if (formData['kesimpulan-akhir'] === 'Baik') score += 10; else if (formData['kesimpulan-akhir'] === 'Cukup') score += 5;

                    setFormData(prev => ({ ...prev, rekapitulasi: score }));
                }, [
                    formData['kepemilikan-kitab'], formData['kelengkapan-kitab'], formData['kondisi-kitab'], 
                    formData['makna-kitab'], formData['ketepatan-makna'], formData['kerapian-makna'], 
                    formData['catatan-kitab'], formData['kualitas-catatan'], formData['kerapian-catatan'], 
                    formData['keberlanjutan-catatan'], formData['kesimpulan-akhir']
                ]);

                const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

                const handleSubmit = (e) => {
                    e.preventDefault();
                    saveDataToSheet('barang', formData);
                    onClose();
                };

                const isEditMode = initialData && initialData.rekapitulasi !== undefined;

                return (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <Card className="w-full max-w-5xl max-h-[90vh] overflow-y-auto p-6 animate-scale-up">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h3 className="text-xl font-bold text-slate-800">{isEditMode ? 'Edit Penilaian' : 'Input Penilaian Baru'}</h3>
                                <p className="text-sm text-slate-500">{formData.nama} - {formData.niup}</p>
                            </div>
                            <button onClick={onClose}><X className="text-slate-400 hover:text-slate-600" /></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="bg-slate-50 p-4 rounded-xl mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                                <div className="lg:col-span-1">
                                    <Input name="niup" label="NIUP Santri" required onChange={handleChange} value={formData.niup} readOnly={true} className="bg-slate-100" />
                                </div>
                                <div className="lg:col-span-4 grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <Input name="nama" label="Nama" value={formData.nama} readOnly className="bg-slate-100" />
                                    <Input name="kamar" label="Kamar" value={formData.kamar} readOnly className="bg-slate-100" />
                                    <Input name="daerah" label="Daerah" value={formData.daerah} readOnly className="bg-slate-100" />
                                    <Input name="wilayah" label="Wilayah" value={formData.wilayah} readOnly className="bg-slate-100" />
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="space-y-4">
                                    <h4 className="font-bold text-emerald-600 border-b pb-2">Kitab Pegangan Santri</h4>
                                    <Select name="kepemilikan-kitab" label="Kepemilikan Kitab" options={['Ya', 'Tidak']} onChange={handleChange} value={formData['kepemilikan-kitab']}/>
                                    <Select name="kelengkapan-kitab" label="Kelengkapan Kitab" options={['Ya', 'Tidak']} onChange={handleChange} value={formData['kelengkapan-kitab']}/>
                                    <Select name="kondisi-kitab" label="Kondisi Fisik" options={['Baik', 'Cukup', 'Rusak']} onChange={handleChange} value={formData['kondisi-kitab']}/>
                                </div>
                                <div className="space-y-4">
                                    <h4 className="font-bold text-emerald-600 border-b pb-2">Kualitas Makna Kitab</h4>
                                    <Select name="makna-kitab" label="Kelengkapan Makna" options={['Lengkap', 'Cukup', 'Tidak']} onChange={handleChange} value={formData['makna-kitab']}/>
                                    <Select name="ketepatan-makna" label="Ketepatan Makna" options={['Baik', 'Cukup', 'Kurang']} onChange={handleChange} value={formData['ketepatan-makna']}/>
                                    <Select name="kerapian-makna" label="Kerapian Makna" options={['Rapi', 'Cukup', 'Tidak']} onChange={handleChange} value={formData['kerapian-makna']}/>
                                </div>
                                <div className="space-y-4">
                                    <h4 className="font-bold text-emerald-600 border-b pb-2">Catatan dan Resume Kitab</h4>
                                    <Select name="catatan-kitab" label="Keberadaan Catatan" options={['Ada', 'Tidak']} onChange={handleChange} value={formData['catatan-kitab']}/>
                                    <Select name="kualitas-catatan" label="Kualitas Catatan" options={['Baik', 'Cukup', 'Kurang']} onChange={handleChange} value={formData['kualitas-catatan']}/>
                                    <Select name="kerapian-catatan" label="Kerapian Catatan" options={['Rapi', 'Cukup', 'Tidak']} onChange={handleChange} value={formData['kerapian-catatan']}/>
                                    <Select name="keberlanjutan-catatan" label="Keberlanjutan" options={['Berurutan', 'Tidak']} onChange={handleChange} value={formData['keberlanjutan-catatan']}/>
                                    <Select name="kesimpulan-akhir" label="Kesimpulan Akhir" options={['Baik', 'Cukup', 'Kurang']} onChange={handleChange} value={formData['kesimpulan-akhir']}/>
                                </div>
                            </div>

                            <div className="mt-6">
                                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1.5">Keterangan</label>
                                <textarea 
                                    name="keterangan" 
                                    value={formData['keterangan'] || ''} 
                                    onChange={handleChange}
                                    className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-slate-700"
                                    rows="3"
                                    placeholder="Tulis keterangan atau catatan tambahan di sini..."
                                ></textarea>
                            </div>
                            
                            <div className="mt-8 flex items-center justify-between bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                <div>
                                    <span className="text-emerald-800 font-bold block text-sm uppercase">Rekapitulasi Nilai</span>
                                    <span className="text-xs text-emerald-600">Dihitung otomatis berdasarkan kriteria</span>
                                </div>
                                <div className="text-4xl font-black text-emerald-600">{formData.rekapitulasi}</div>
                            </div>

                            <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                                <Button variant="secondary" onClick={onClose}>Batal</Button>
                                <Button type="submit" disabled={loading}>{loading ? 'Menyimpan...' : 'Simpan Penilaian'}</Button>
                            </div>
                        </form>
                        </Card>
                    </div>
                );
            };

            const TableView = ({ title, columns, data, onAdd, extraHeader, onRowDoubleClick }) => {
                const [searchTerm, setSearchTerm] = useState('');
                const [showFilters, setShowFilters] = useState(false);
                const [activeFilters, setActiveFilters] = useState({
                    kamar: '', daerah: '', wilayah: '', pendidikan: '',
                    jurusan: '', kelas: '', jenjang: '', 'majelis-pagi': '', 'majelis-sore': ''
                });

                const getUniqueOptions = (key) => {
                    const values = data.map(item => item[key]).filter(val => val !== undefined && val !== '');
                    return [...new Set(values)].sort();
                };

                const handleFilterChange = (key, value) => {
                    setActiveFilters(prev => ({ ...prev, [key]: value }));
                };
                
                const clearFilters = () => {
                    setActiveFilters({
                        kamar: '', daerah: '', wilayah: '', pendidikan: '',
                        jurusan: '', kelas: '', jenjang: '', 'majelis-pagi': '', 'majelis-sore': ''
                    });
                };

                const filteredData = data.filter(item => {
                    const matchesSearch = Object.values(item).some(val => 
                        String(val).toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    const matchesFilters = Object.entries(activeFilters).every(([key, value]) => {
                        if (!value) return true; 
                        return String(item[key]) === String(value);
                    });
                    return matchesSearch && matchesFilters;
                });

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                    {title}
                                    <span className="text-xs font-semibold bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full">{filteredData.length}</span>
                                </h2>
                                <p className="text-slate-500">Kelola database {title.toLowerCase()} disini.</p>
                            </div>
                            <div className="flex gap-3">
                                <div className="relative">
                                    <Search className="absolute left-3 top-2.5 w-5 h-5 text-slate-400" />
                                    <input 
                                        type="text" 
                                        placeholder="Cari data..." 
                                        className="pl-10 pr-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 w-full md:w-64"
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <Button variant="secondary" onClick={() => setShowFilters(!showFilters)}>
                                    <Filter className="w-5 h-5"/> Filter
                                </Button>
                                {onAdd && <Button onClick={onAdd}><Plus className="w-5 h-5"/> Tambah</Button>}
                            </div>
                        </div>

                        {showFilters && (
                            <Card className="p-4 bg-slate-50 border-emerald-100 animate-fade-in">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-2">
                                    <h4 className="font-bold text-slate-700 flex items-center gap-2"><Filter className="w-4 h-4" /> Filter Data</h4>
                                    <button onClick={clearFilters} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                                        <XCircle className="w-3 h-3" /> Reset Filter
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                    <Select label="Kamar" value={activeFilters.kamar} onChange={(e) => handleFilterChange('kamar', e.target.value)} options={getUniqueOptions('kamar')} />
                                    <Select label="Daerah" value={activeFilters.daerah} onChange={(e) => handleFilterChange('daerah', e.target.value)} options={getUniqueOptions('daerah')} />
                                    <Select label="Wilayah" value={activeFilters.wilayah} onChange={(e) => handleFilterChange('wilayah', e.target.value)} options={getUniqueOptions('wilayah')} />
                                    <Select label="Pendidikan" value={activeFilters.pendidikan} onChange={(e) => handleFilterChange('pendidikan', e.target.value)} options={getUniqueOptions('pendidikan')} />
                                    <Select label="Jurusan" value={activeFilters.jurusan} onChange={(e) => handleFilterChange('jurusan', e.target.value)} options={getUniqueOptions('jurusan')} />
                                    <Select label="Kelas" value={activeFilters.kelas} onChange={(e) => handleFilterChange('kelas', e.target.value)} options={getUniqueOptions('kelas')} />
                                    <Select label="Jenjang" value={activeFilters.jenjang} onChange={(e) => handleFilterChange('jenjang', e.target.value)} options={getUniqueOptions('jenjang')} />
                                    <Select label="Majelis Pagi" value={activeFilters['majelis-pagi']} onChange={(e) => handleFilterChange('majelis-pagi', e.target.value)} options={getUniqueOptions('majelis-pagi')} />
                                    <Select label="Majelis Sore" value={activeFilters['majelis-sore']} onChange={(e) => handleFilterChange('majelis-sore', e.target.value)} options={getUniqueOptions('majelis-sore')} />
                                </div>
                            </Card>
                        )}

                        {extraHeader}

                        <Card className="overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            {columns.map((col, idx) => (
                                                <th key={idx} className="px-6 py-4 font-semibold whitespace-nowrap">{col.header}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredData.map((row, idx) => (
                                            <tr 
                                                key={idx} 
                                                className="border-b border-slate-50 hover:bg-slate-50 transition-colors cursor-pointer"
                                                onDoubleClick={() => onRowDoubleClick && onRowDoubleClick(row)}
                                            >
                                                {columns.map((col, cIdx) => (
                                                    <td key={cIdx} className="px-6 py-4 whitespace-nowrap">
                                                        {col.render ? col.render(row, idx) : row[col.accessor]}
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                        {filteredData.length === 0 && (
                                            <tr>
                                                <td colSpan={columns.length} className="px-6 py-12 text-center text-slate-400">
                                                    Tidak ada data ditemukan sesuai filter.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <div className="bg-slate-50 px-6 py-4 border-t border-slate-100 text-xs text-slate-500 flex justify-between items-center">
                                <span>Menampilkan {filteredData.length} dari {data.length} data</span>
                                <span className="text-slate-400 italic">Klik 2x pada baris untuk detail/edit</span>
                            </div>
                        </Card>
                    </div>
                )
            }

            const renderOwnershipView = () => {
                const filledNiups = new Set(barangData.map(b => String(b.niup)));
                
                const missingData = santriData.filter(s => !filledNiups.has(String(s.niup)));
                const filledData = getMergedBarangData(); 

                const openForm = (data, mode) => {
                    setEditBarangData(data);
                    setShowBarangModal(true);
                };

                return (
                    <TableView 
                        title="Data Kepemilikan"
                        data={ownershipTab === 'missing' ? missingData : filledData}
                        onAdd={null} 
                        extraHeader={
                            <div className="flex space-x-1 bg-slate-100 p-1 rounded-xl w-fit">
                                <button 
                                    onClick={() => setOwnershipTab('missing')}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                        ownershipTab === 'missing' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    Belum Diisi ({missingData.length})
                                </button>
                                <button 
                                    onClick={() => setOwnershipTab('filled')}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                        ownershipTab === 'filled' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    Sudah Diisi ({filledData.length})
                                </button>
                            </div>
                        }
                        columns={ownershipTab === 'missing' ? [
                            { header: 'No', render: (_, idx) => idx + 1 },
                            { header: 'NIUP', accessor: 'niup' },
                            { header: 'Nama', accessor: 'nama' },
                            { header: 'Kamar', accessor: 'kamar' },
                            { header: 'Kelas', accessor: 'kelas' },
                            { header: 'Aksi', render: (row) => (
                                <Button variant="info" className="py-1 px-3 text-xs" onClick={() => openForm(row, 'create')}>
                                    <UserPlus className="w-3 h-3" /> Input
                                </Button>
                            )}
                        ] : [
                            { header: 'No', render: (_, idx) => idx + 1 },
                            { header: 'NIUP', accessor: 'niup' },
                            { header: 'Nama', accessor: 'nama' },
                            { header: 'Kitab', render: (row) => (
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${row['kepemilikan-kitab'] === 'Ya' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {row['kepemilikan-kitab']}
                                </span>
                            )},
                            { header: 'Rekapitulasi', render: (row) => (
                                <span className="font-bold text-emerald-600">{row.rekapitulasi}</span>
                            )},
                            { header: 'Aksi', render: (row) => (
                                <div className="flex gap-2">
                                    <Button variant="secondary" className="py-1 px-2 text-xs" onClick={() => openForm(row, 'edit')}>
                                        <Edit2 className="w-3 h-3" /> Detail/Edit
                                    </Button>
                                </div>
                            )}
                        ]}
                    />
                );
            };

            const SettingsView = () => (
                <div className="max-w-2xl mx-auto space-y-6 animate-fade-in">
                    <div className="text-center mb-8">
                        <h2 className="text-2xl font-bold text-slate-800">Pengaturan Aplikasi</h2>
                        <p className="text-slate-500">Konfigurasi koneksi database Google Sheets.</p>
                    </div>

                    <Card className="p-8">
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">Google Apps Script Web App URL</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={webAppUrl}
                                        onChange={(e) => setWebAppUrl(e.target.value)}
                                        placeholder="https://script.google.com/macros/s/..."
                                        className="flex-1 px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 outline-none"
                                    />
                                    <Button onClick={() => {
                                        localStorage.setItem('pdk_webapp_url', webAppUrl);
                                        showToast("URL tersimpan!", "success");
                                    }}>
                                        <Save className="w-4 h-4" /> Simpan
                                    </Button>
                                </div>
                            </div>

                            <div className="border-t border-slate-100 pt-6">
                                <h4 className="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                                    <Activity className="w-4 h-4 text-slate-500" />
                                    Status Koneksi
                                </h4>
                                <div className="flex items-center justify-between bg-slate-50 p-4 rounded-xl">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                                            connectionStatus === 'success' ? 'bg-green-100 text-green-600' : 
                                            connectionStatus === 'error' ? 'bg-red-100 text-red-600' :
                                            'bg-slate-200 text-slate-500'
                                        }`}>
                                            {connectionStatus === 'success' ? <Wifi className="w-5 h-5" /> : 
                                            connectionStatus === 'error' ? <WifiOff className="w-5 h-5" /> :
                                            <Activity className="w-5 h-5" />}
                                        </div>
                                        <div>
                                            <p className="text-sm font-medium text-slate-900">
                                                {connectionStatus === 'success' ? 'Terhubung' : 
                                                connectionStatus === 'error' ? 'Gagal Terhubung' : 
                                                connectionStatus === 'testing' ? 'Sedang mengecek...' :
                                                'Belum dicek'}
                                            </p>
                                            <p className="text-xs text-slate-500">
                                                {connectionStatus === 'success' ? 'Siap mengirim data.' : 
                                                'Klik tombol di kanan untuk tes.'}
                                            </p>
                                        </div>
                                    </div>
                                    <Button 
                                        variant={connectionStatus === 'success' ? 'success' : 'secondary'} 
                                        onClick={testConnection} 
                                        disabled={connectionStatus === 'testing'}
                                    >
                                        {connectionStatus === 'testing' ? 'Loading...' : 'Tes Koneksi'}
                                    </Button>
                                </div>
                            </div>
                            
                            <p className="text-xs text-slate-500 bg-slate-50 p-4 rounded-lg leading-relaxed mt-4">
                                <strong>Catatan:</strong><br/>
                                Jika Tes Koneksi gagal (Error CORS), bukan berarti aplikasi rusak. Google sering memblokir "Test/Ping" dari browser langsung. Coba simpan data santri; jika berhasil, maka aplikasi berjalan normal.
                            </p>
                        </div>
                    </Card>
                </div>
            )

            // --- Main Layout Render ---

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">
                {/* Global Loading Screen */}
                {(!initialLoadDone) && <LoadingScreen />}
                
                {/* Toast Notification */}
                {notification && (
                    <Toast 
                        message={notification.message} 
                        type={notification.type} 
                        onClose={() => setNotification(null)} 
                    />
                )}

                {/* Sidebar Desktop - Disembunyikan di Mobile */}
                <aside className={`bg-white border-r border-slate-200 hidden md:flex flex-col transition-all duration-300 z-20 ${isSidebarOpen ? 'w-64' : 'w-20'} h-full`}>
                    <div className="h-20 flex items-center justify-center border-b border-slate-100">
                        <div className={`flex items-center gap-3 ${!isSidebarOpen && 'justify-center'}`}>
                            <div className="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-emerald-200">
                                PDK
                            </div>
                            {isSidebarOpen && <span className="font-bold text-xl tracking-tight text-emerald-950">PDK System</span>}
                        </div>
                    </div>

                    <nav className="flex-1 py-6 px-3 space-y-2 overflow-y-auto">
                        {navItems.map(item => (
                            <button 
                                key={item.id}
                                onClick={() => { setView(item.id); if(window.innerWidth < 768) setIsSidebarOpen(false); }}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                                    view === item.id 
                                    ? 'bg-emerald-50 text-emerald-700 font-semibold shadow-sm' 
                                    : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                                } ${!isSidebarOpen && 'justify-center px-2'}`}
                            >
                                <item.icon className="w-5 h-5" />
                                {isSidebarOpen && <span>{item.label}</span>}
                            </button>
                        ))}
                    </nav>

                    <div className="p-4 border-t border-slate-100">
                        <button 
                            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                            className="w-full flex items-center justify-center p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-50 rounded-lg transition"
                        >
                            {isSidebarOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
                        </button>
                    </div>
                </aside>

                {/* Main Content */}
                <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                    {/* Header Mobile - Hanya Title */}
                    <header className="md:hidden h-16 bg-white border-b border-slate-200 flex items-center px-4 justify-center">
                        <span className="font-bold text-lg text-emerald-800">PDK System</span>
                    </header>

                    <div className="flex-1 overflow-y-auto p-4 md:p-8 relative pb-24 md:pb-8">
                        {view === 'dashboard' && <Dashboard />}
                        
                        {view === 'santri' && (
                            <TableView 
                                title="Data Santri"
                                data={santriData}
                                onAdd={() => {
                                    setEditSantriData(null);
                                    setShowSantriModal(true);
                                }}
                                onRowDoubleClick={(row) => {
                                    setEditSantriData(row);
                                    setShowSantriModal(true);
                                }}
                                columns={[
                                    { header: 'No', render: (_, idx) => idx + 1 },
                                    { header: 'NIUP', accessor: 'niup' },
                                    { header: 'Nama', accessor: 'nama' },
                                    { header: 'Kamar', accessor: 'kamar' },
                                    { header: 'Daerah', accessor: 'daerah' },
                                    { header: 'Wilayah', accessor: 'wilayah' },
                                    { header: 'Pendidikan', accessor: 'pendidikan' },
                                    { header: 'Jurusan', accessor: 'jurusan' },
                                    { header: 'Kelas', accessor: 'kelas' },
                                    { header: 'Jenjang', accessor: 'jenjang' },
                                    { header: 'Majelis Pagi', accessor: 'majelis-pagi' },
                                    { header: 'Majelis Sore', accessor: 'majelis-sore' },
                                    { header: 'Majelis Kamis Pagi', accessor: 'majelis-kamis-pagi' },
                                    { header: 'Majelis Kamis Sore', accessor: 'majelis-kamis-sore' },
                                ]}
                            />
                        )}

                        {view === 'barang' && renderOwnershipView()}

                        {view === 'settings' && <SettingsView />}
                    </div>

                    {/* Bottom Navigation Bar - Hanya Mobile */}
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center p-3 z-30 safe-area-bottom shadow-lg">
                      {navItems.map(item => (
                        <button
                          key={item.id}
                          onClick={() => setView(item.id)}
                          className={`flex items-center justify-center p-2 rounded-full transition-all duration-300 ${
                            view === item.id 
                              ? 'bg-emerald-100 text-emerald-700 px-4' 
                              : 'text-slate-400 w-12'
                          }`}
                        >
                          <item.icon className="w-6 h-6" />
                          {view === item.id && (
                            <span className="ml-2 text-sm font-medium whitespace-nowrap animate-slide-in-right">
                              {item.label}
                            </span>
                          )}
                        </button>
                      ))}
                    </nav>
                </main>

                {/* Modals */}
                {showSantriModal && <SantriForm onClose={() => setShowSantriModal(false)} initialData={editSantriData} />}
                {showBarangModal && <BarangForm onClose={() => setShowBarangModal(false)} initialData={editBarangData} />}
                </div>
            );
        }

        // Initialize App
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>