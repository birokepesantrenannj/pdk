<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDK - Pengelolaan Data Kepesantrenan</title>
    <meta name="description" content="Aplikasi Manajemen Data Santri dan Kitab">
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Konfigurasi Import Map untuk React & Icons via CDN -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>
    
    <!-- 3. Babel Standalone (Untuk compile JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles untuk Scrollbar & Animasi -->
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-scale-up { animation: scaleUp 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased overflow-hidden">
    
    <!-- Container Utama React -->
    <div id="root"></div>

    <!-- Kode Aplikasi React -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, Users, Package, Settings, Plus, Save, Search, 
            Trash2, Edit2, CheckCircle, AlertCircle, Menu, X, BookOpen, 
            TrendingUp, Award, Wifi, WifiOff, Activity, UserPlus, Filter, XCircle
        } from 'lucide-react';

        // --- Komponen UI Reusable ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all duration-300 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled = false, type = "button" }) => {
            const baseStyle = "px-4 py-2 rounded-xl font-medium transition-all duration-200 flex items-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg shadow-emerald-200",
                secondary: "bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:border-slate-300",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
                ghost: "bg-transparent text-slate-500 hover:bg-slate-100",
                success: "bg-green-100 text-green-700 border border-green-200 hover:bg-green-200",
                info: "bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-100"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                {children}
                </button>
            );
        };

        const Input = ({ label, ...props }) => (
            <div className="flex flex-col gap-1.5">
                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>
                <input 
                {...props}
                className={`w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-slate-700 ${props.readOnly ? 'bg-slate-100' : ''}`}
                />
            </div>
        );

        const Select = ({ label, options, ...props }) => (
            <div className="flex flex-col gap-1.5">
                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>
                <div className="relative">
                <select 
                    {...props}
                    className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-slate-700 appearance-none"
                >
                    <option value="">Pilih...</option>
                    {options.map(opt => (
                    <option key={opt} value={opt}>{opt}</option>
                    ))}
                </select>
                <div className="absolute right-3 top-3 pointer-events-none text-slate-400">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                </div>
            </div>
        );

        // --- Main App Component ---

        function App() {
            const [view, setView] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            // URL Web App
            const [webAppUrl, setWebAppUrl] = useState('https://script.google.com/macros/s/AKfycbwTdH0n0IPEFMKrIpflNzxxwIH8vL6evXGtbefzN66X15bnJVgmOkPhmMIoWujjHiyn/exec');
            const [loading, setLoading] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('idle');
            
            // Data State
            const [santriData, setSantriData] = useState([]);
            const [barangData, setBarangData] = useState([]);
            
            // State untuk Tab Kepemilikan (missing | filled)
            const [ownershipTab, setOwnershipTab] = useState('missing');

            // State Modal & Edit
            const [showSantriModal, setShowSantriModal] = useState(false);
            const [showBarangModal, setShowBarangModal] = useState(false);
            const [editBarangData, setEditBarangData] = useState(null);

            // Load URL & Fetch Data on Mount
            useEffect(() => {
                const savedUrl = localStorage.getItem('pdk_webapp_url');
                if (savedUrl) {
                    setWebAppUrl(savedUrl);
                }
                
                // Mock Data jika kosong
                if(santriData.length === 0) {
                    setSantriData([
                    { niup: '12345', nama: 'Ahmad Fauzi', kamar: 'A1', daerah: 'Jawa Timur', kelas: '3 Ulya', jenjang: 'Ulya' }
                    ]);
                }
            }, []);

            // Effect fetch data saat URL ada
            useEffect(() => {
                if (webAppUrl) {
                    fetchData(webAppUrl, true);
                }
            }, [webAppUrl]);

            // --- Logic Koneksi ---

            const testConnection = async () => {
                setConnectionStatus('testing');
                try {
                    const response = await fetch(`${webAppUrl}?action=ping`);
                    if (response.ok || response.type === 'opaque') {
                        await fetchData(webAppUrl);
                        setConnectionStatus('success');
                        alert("Koneksi Berhasil! Aplikasi terhubung ke Google Sheet.");
                    } else {
                        throw new Error("Response status not OK");
                    }
                } catch (error) {
                    console.error("Connection Error:", error);
                    setConnectionStatus('error');
                    alert("Koneksi Gagal. Pastikan URL benar, script dideploy sebagai 'Anyone', dan internet lancar.");
                }
            };

            const fetchData = async (urlToUse, silent = false) => {
                const url = urlToUse || webAppUrl;
                if (!url) return;
                
                if(!silent) setLoading(true);
                try {
                    const response = await fetch(`${url}?action=getData`); 
                    if (!response.ok) throw new Error("Network response was not ok");
                    
                    const data = await response.json();
                    
                    if(data.santri && Array.isArray(data.santri)) setSantriData(data.santri);
                    if(data.barang && Array.isArray(data.barang)) setBarangData(data.barang);
                    
                    if(!silent) console.log("Data berhasil diambil:", data);
                } catch (error) {
                    if(!silent) console.error("Gagal mengambil data:", error);
                } finally {
                    if(!silent) setLoading(false);
                }
            };

            const saveDataToSheet = async (type, data) => {
                if (!webAppUrl) {
                    alert("URL Web App belum diatur! Masuk ke menu Pengaturan.");
                    return;
                }

                setLoading(true);
                try {
                    await fetch(webAppUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type, data })
                    });
                    
                    // Update local state (Optimistic UI)
                    if(type === 'santri') setSantriData([...santriData, data]);
                    if(type === 'barang') {
                        const filtered = barangData.filter(b => b.niup !== data.niup);
                        setBarangData([...filtered, data]);
                    }
                    
                    alert("Data berhasil disimpan ke Google Sheets!");
                } catch (error) {
                    console.error(error);
                    alert("Terjadi kesalahan saat mengirim data.");
                } finally {
                    setLoading(false);
                }
            };

            // --- Views ---

            const Dashboard = () => {
                const stats = [
                    { label: "Total Santri", value: santriData.length, icon: Users, color: "text-blue-600", bg: "bg-blue-50" },
                    { label: "Data Kepemilikan", value: barangData.length, icon: Package, color: "text-emerald-600", bg: "bg-emerald-50" },
                    { label: "Belum Input", value: Math.max(0, santriData.length - barangData.length), icon: AlertCircle, color: "text-red-600", bg: "bg-red-50" },
                    { label: "Predikat Baik", value: barangData.filter(b => b.rekapitulasi >= 80).length, icon: Award, color: "text-amber-600", bg: "bg-amber-50" },
                ];

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Dashboard</h2>
                                <p className="text-slate-500">Ringkasan data kepesantrenan terkini.</p>
                            </div>
                            <Button variant="secondary" onClick={() => fetchData(webAppUrl)} disabled={loading}>
                                {loading ? 'Memuat...' : 'Refresh Data'}
                            </Button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            {stats.map((stat, idx) => (
                                <Card key={idx} className="p-6 flex items-center gap-4">
                                <div className={`p-4 rounded-xl ${stat.bg}`}>
                                    <stat.icon className={`w-6 h-6 ${stat.color}`} />
                                </div>
                                <div>
                                    <p className="text-sm font-medium text-slate-500">{stat.label}</p>
                                    <h3 className="text-2xl font-bold text-slate-800">{stat.value}</h3>
                                </div>
                                </Card>
                            ))}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card className="p-6">
                                <h3 className="font-bold text-slate-800 mb-4">Santri Terbaru</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-600">
                                        <thead className="text-xs text-slate-400 uppercase bg-slate-50">
                                            <tr>
                                                <th className="px-4 py-3 rounded-l-lg">Nama</th>
                                                <th className="px-4 py-3">Kelas</th>
                                                <th className="px-4 py-3 rounded-r-lg">Kamar</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {santriData.slice(-5).map((s, i) => (
                                                <tr key={i} className="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-medium text-slate-800">{s.nama}</td>
                                                    <td className="px-4 py-3">{s.kelas}</td>
                                                    <td className="px-4 py-3">{s.kamar}</td>
                                                </tr>
                                            ))}
                                            {santriData.length === 0 && (
                                                <tr><td colSpan="3" className="text-center py-4 text-slate-400">Belum ada data</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                            
                            <Card className="p-6 bg-gradient-to-br from-emerald-600 to-teal-800 text-white border-none">
                                <div className="h-full flex flex-col justify-between">
                                    <div>
                                        <h3 className="font-bold text-xl mb-2">Selamat Datang di PDK</h3>
                                        <p className="text-emerald-100 opacity-90">Sistem Pengelolaan Data Kepesantrenan Santri yang terintegrasi. Kelola data santri dan aset intelektual (kitab) dengan mudah dan presisi.</p>
                                    </div>
                                    <div className="mt-8 flex gap-3">
                                        <button onClick={() => setView('santri')} className="bg-white/20 backdrop-blur-sm hover:bg-white/30 px-4 py-2 rounded-lg font-medium transition text-sm">Kelola Santri</button>
                                        <button onClick={() => setView('barang')} className="bg-white text-emerald-800 hover:bg-emerald-50 px-4 py-2 rounded-lg font-medium transition text-sm">Input Kitab</button>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            };

            const SantriForm = ({ onClose }) => {
                const [formData, setFormData] = useState({
                    niup: '', nama: '', kamar: '', daerah: '', wilayah: '', 
                    pendidikan: '', jurusan: '', kelas: '', jenjang: '', 
                    majelisPagi: '', majelisSore: '', majelisKamisPagi: '', majelisKamisSore: ''
                });

                const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

                const handleSubmit = (e) => {
                    e.preventDefault();
                    saveDataToSheet('santri', formData);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <Card className="w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 animate-scale-up">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-slate-800">Tambah Data Santri</h3>
                            <button onClick={onClose}><X className="text-slate-400 hover:text-slate-600" /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            <Input name="niup" label="NIUP" required onChange={handleChange} />
                            <Input name="nama" label="Nama Lengkap" required onChange={handleChange} />
                            <Input name="kamar" label="Kamar" onChange={handleChange} />
                            <Input name="daerah" label="Daerah" onChange={handleChange} />
                            <Input name="wilayah" label="Wilayah" onChange={handleChange} />
                            <Input name="pendidikan" label="Pendidikan Formal" onChange={handleChange} />
                            <Input name="jurusan" label="Jurusan" onChange={handleChange} />
                            <Input name="kelas" label="Kelas" onChange={handleChange} />
                            <Input name="jenjang" label="Jenjang" onChange={handleChange} />
                            
                            <div className="col-span-full border-t border-slate-100 pt-4 mt-2">
                                <h4 className="text-sm font-bold text-emerald-600 mb-4 uppercase tracking-wide">Data Majelis</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <Input name="majelisPagi" label="Majelis Pagi" onChange={handleChange} />
                                    <Input name="majelisSore" label="Majelis Sore" onChange={handleChange} />
                                    <Input name="majelisKamisPagi" label="Majelis Kamis Pagi" onChange={handleChange} />
                                    <Input name="majelisKamisSore" label="Majelis Kamis Sore" onChange={handleChange} />
                                </div>
                            </div>

                            <div className="col-span-full flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                                <Button variant="secondary" onClick={onClose}>Batal</Button>
                                <Button type="submit" disabled={loading}>{loading ? 'Menyimpan...' : 'Simpan Data'}</Button>
                            </div>
                        </form>
                        </Card>
                    </div>
                );
            };

            const BarangForm = ({ onClose, initialData = null }) => {
                const defaultData = {
                    niup: '', nama: '', kamar: '', daerah: '', wilayah: '',
                    kepemilikan: 'Tidak', kelengkapan: 'Tidak', kondisi: 'Rusak', 
                    makna: 'Tidak', ketepatan: 'Kurang', kerapianMakna: 'Tidak',
                    catatan: 'Tidak', kualitasCatatan: 'Kurang', kerapianCatatan: 'Tidak',
                    keberlanjutan: 'Tidak', kesimpulan: 'Kurang', rekapitulasi: 0
                };

                const [formData, setFormData] = useState(defaultData);

                // Populate data jika edit/create from santri
                useEffect(() => {
                    if (initialData) {
                        setFormData(prev => ({ ...prev, ...initialData }));
                    }
                }, [initialData]);

                useEffect(() => {
                    let score = 0;
                    if (formData.kepemilikan === 'Ya') score += 10;
                    if (formData.kelengkapan === 'Ya') score += 10;
                    if (formData.kondisi === 'Baik') score += 10; else if (formData.kondisi === 'Cukup') score += 5;
                    if (formData.makna === 'Lengkap') score += 10; else if (formData.makna === 'Cukup') score += 5;
                    if (formData.ketepatan === 'Baik') score += 10; else if (formData.ketepatan === 'Cukup') score += 5;
                    if (formData.kerapianMakna === 'Rapi') score += 10; else if (formData.kerapianMakna === 'Cukup') score += 5;
                    if (formData.catatan === 'Ada') score += 10;
                    if (formData.kualitasCatatan === 'Baik') score += 10; else if (formData.kualitasCatatan === 'Cukup') score += 5;
                    if (formData.kerapianCatatan === 'Rapi') score += 5; else if (formData.kerapianCatatan === 'Cukup') score += 2.5;
                    if (formData.keberlanjutan === 'Berurutan') score += 5;
                    if (formData.kesimpulan === 'Baik') score += 10; else if (formData.kesimpulan === 'Cukup') score += 5;

                    setFormData(prev => ({ ...prev, rekapitulasi: score }));
                }, [formData.kepemilikan, formData.kelengkapan, formData.kondisi, formData.makna, formData.ketepatan, formData.kerapianMakna, formData.catatan, formData.kualitasCatatan, formData.kerapianCatatan, formData.keberlanjutan, formData.kesimpulan]);

                const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

                const handleSubmit = (e) => {
                    e.preventDefault();
                    saveDataToSheet('barang', formData);
                    onClose();
                };

                const isEditMode = initialData && initialData.rekapitulasi !== undefined;

                return (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <Card className="w-full max-w-5xl max-h-[90vh] overflow-y-auto p-6 animate-scale-up">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h3 className="text-xl font-bold text-slate-800">{isEditMode ? 'Edit Penilaian' : 'Input Penilaian Baru'}</h3>
                                <p className="text-sm text-slate-500">{formData.nama} - {formData.niup}</p>
                            </div>
                            <button onClick={onClose}><X className="text-slate-400 hover:text-slate-600" /></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="bg-slate-50 p-4 rounded-xl mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                                <div className="lg:col-span-1">
                                    <Input name="niup" label="NIUP Santri" required onChange={handleChange} value={formData.niup} readOnly={true} className="bg-slate-100" />
                                </div>
                                <div className="lg:col-span-4 grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <Input name="nama" label="Nama" value={formData.nama} readOnly className="bg-slate-100" />
                                    <Input name="kamar" label="Kamar" value={formData.kamar} readOnly className="bg-slate-100" />
                                    <Input name="daerah" label="Daerah" value={formData.daerah} readOnly className="bg-slate-100" />
                                    <Input name="wilayah" label="Wilayah" value={formData.wilayah} readOnly className="bg-slate-100" />
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="space-y-4">
                                    <h4 className="font-bold text-emerald-600 border-b pb-2">Kondisi Kitab</h4>
                                    <Select name="kepemilikan" label="Kepemilikan Kitab" options={['Ya', 'Tidak']} onChange={handleChange} value={formData.kepemilikan}/>
                                    <Select name="kelengkapan" label="Kelengkapan Kitab" options={['Ya', 'Tidak']} onChange={handleChange} value={formData.kelengkapan}/>
                                    <Select name="kondisi" label="Kondisi Fisik" options={['Baik', 'Cukup', 'Rusak']} onChange={handleChange} value={formData.kondisi}/>
                                </div>
                                <div className="space-y-4">
                                    <h4 className="font-bold text-emerald-600 border-b pb-2">Kualitas Makna</h4>
                                    <Select name="makna" label="Kelengkapan Makna" options={['Lengkap', 'Cukup', 'Tidak']} onChange={handleChange} value={formData.makna}/>
                                    <Select name="ketepatan" label="Ketepatan Makna" options={['Baik', 'Cukup', 'Kurang']} onChange={handleChange} value={formData.ketepatan}/>
                                    <Select name="kerapianMakna" label="Kerapian Makna" options={['Rapi', 'Cukup', 'Tidak']} onChange={handleChange} value={formData.kerapianMakna}/>
                                </div>
                                <div className="space-y-4">
                                    <h4 className="font-bold text-emerald-600 border-b pb-2">Catatan & Resume</h4>
                                    <Select name="catatan" label="Keberadaan Catatan" options={['Ada', 'Tidak']} onChange={handleChange} value={formData.catatan}/>
                                    <Select name="kualitasCatatan" label="Kualitas Catatan" options={['Baik', 'Cukup', 'Kurang']} onChange={handleChange} value={formData.kualitasCatatan}/>
                                    <Select name="kerapianCatatan" label="Kerapian Catatan" options={['Rapi', 'Cukup', 'Tidak']} onChange={handleChange} value={formData.kerapianCatatan}/>
                                    <Select name="keberlanjutan" label="Keberlanjutan" options={['Berurutan', 'Tidak']} onChange={handleChange} value={formData.keberlanjutan}/>
                                    <Select name="kesimpulan" label="Kesimpulan Akhir" options={['Baik', 'Cukup', 'Kurang']} onChange={handleChange} value={formData.kesimpulan}/>
                                </div>
                            </div>
                            
                            <div className="mt-8 flex items-center justify-between bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                <div>
                                    <span className="text-emerald-800 font-bold block text-sm uppercase">Rekapitulasi Nilai</span>
                                    <span className="text-xs text-emerald-600">Dihitung otomatis berdasarkan kriteria</span>
                                </div>
                                <div className="text-4xl font-black text-emerald-600">{formData.rekapitulasi}</div>
                            </div>

                            <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                                <Button variant="secondary" onClick={onClose}>Batal</Button>
                                <Button type="submit" disabled={loading}>{loading ? 'Menyimpan...' : 'Simpan Penilaian'}</Button>
                            </div>
                        </form>
                        </Card>
                    </div>
                );
            };

            const TableView = ({ title, columns, data, onAdd, extraHeader }) => {
                const [searchTerm, setSearchTerm] = useState('');
                // State untuk filter
                const [showFilters, setShowFilters] = useState(false);
                const [activeFilters, setActiveFilters] = useState({
                    kamar: '',
                    daerah: '',
                    wilayah: '',
                    pendidikan: '',
                    jurusan: '',
                    kelas: '',
                    jenjang: '',
                    majelisPagi: '',
                    majelisSore: ''
                });

                // Helper untuk mendapatkan opsi unik dari data
                const getUniqueOptions = (key) => {
                    const values = data.map(item => item[key]).filter(val => val !== undefined && val !== '');
                    return [...new Set(values)].sort();
                };

                const handleFilterChange = (key, value) => {
                    setActiveFilters(prev => ({ ...prev, [key]: value }));
                };
                
                const clearFilters = () => {
                    setActiveFilters({
                        kamar: '', daerah: '', wilayah: '', pendidikan: '',
                        jurusan: '', kelas: '', jenjang: '', majelisPagi: '', majelisSore: ''
                    });
                };

                const filteredData = data.filter(item => {
                    // 1. Cek Search
                    const matchesSearch = Object.values(item).some(val => 
                        String(val).toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    
                    // 2. Cek Filters (Hanya jika value filter tidak kosong)
                    const matchesFilters = Object.entries(activeFilters).every(([key, value]) => {
                        if (!value) return true; // Skip jika filter kosong
                        // Pastikan property ada pada item, jika tidak ada (misal di data barang tidak ada majelis), kita skip atau anggap false.
                        // Disini kita gunakan String comparison yang aman.
                        return String(item[key]) === String(value);
                    });

                    return matchesSearch && matchesFilters;
                });

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">{title}</h2>
                                <p className="text-slate-500">Kelola database {title.toLowerCase()} disini.</p>
                            </div>
                            <div className="flex gap-3">
                                <div className="relative">
                                    <Search className="absolute left-3 top-2.5 w-5 h-5 text-slate-400" />
                                    <input 
                                        type="text" 
                                        placeholder="Cari data..." 
                                        className="pl-10 pr-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 w-full md:w-64"
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <Button variant="secondary" onClick={() => setShowFilters(!showFilters)}>
                                    <Filter className="w-5 h-5"/> Filter
                                </Button>
                                {onAdd && <Button onClick={onAdd}><Plus className="w-5 h-5"/> Tambah</Button>}
                            </div>
                        </div>

                        {/* Filter Section */}
                        {showFilters && (
                            <Card className="p-4 bg-slate-50 border-emerald-100 animate-fade-in">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-2">
                                    <h4 className="font-bold text-slate-700 flex items-center gap-2"><Filter className="w-4 h-4" /> Filter Data</h4>
                                    <button onClick={clearFilters} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                                        <XCircle className="w-3 h-3" /> Reset Filter
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                    <Select label="Kamar" value={activeFilters.kamar} onChange={(e) => handleFilterChange('kamar', e.target.value)} options={getUniqueOptions('kamar')} />
                                    <Select label="Daerah" value={activeFilters.daerah} onChange={(e) => handleFilterChange('daerah', e.target.value)} options={getUniqueOptions('daerah')} />
                                    <Select label="Wilayah" value={activeFilters.wilayah} onChange={(e) => handleFilterChange('wilayah', e.target.value)} options={getUniqueOptions('wilayah')} />
                                    <Select label="Pendidikan" value={activeFilters.pendidikan} onChange={(e) => handleFilterChange('pendidikan', e.target.value)} options={getUniqueOptions('pendidikan')} />
                                    <Select label="Jurusan" value={activeFilters.jurusan} onChange={(e) => handleFilterChange('jurusan', e.target.value)} options={getUniqueOptions('jurusan')} />
                                    <Select label="Kelas" value={activeFilters.kelas} onChange={(e) => handleFilterChange('kelas', e.target.value)} options={getUniqueOptions('kelas')} />
                                    <Select label="Jenjang" value={activeFilters.jenjang} onChange={(e) => handleFilterChange('jenjang', e.target.value)} options={getUniqueOptions('jenjang')} />
                                    <Select label="Majelis Pagi" value={activeFilters.majelisPagi} onChange={(e) => handleFilterChange('majelisPagi', e.target.value)} options={getUniqueOptions('majelisPagi')} />
                                    <Select label="Majelis Sore" value={activeFilters.majelisSore} onChange={(e) => handleFilterChange('majelisSore', e.target.value)} options={getUniqueOptions('majelisSore')} />
                                </div>
                            </Card>
                        )}

                        {extraHeader}

                        <Card className="overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            {columns.map((col, idx) => (
                                                <th key={idx} className="px-6 py-4 font-semibold">{col.header}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredData.map((row, idx) => (
                                            <tr key={idx} className="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                                {columns.map((col, cIdx) => (
                                                    <td key={cIdx} className="px-6 py-4">
                                                        {col.render ? col.render(row) : row[col.accessor]}
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                        {filteredData.length === 0 && (
                                            <tr>
                                                <td colSpan={columns.length} className="px-6 py-12 text-center text-slate-400">
                                                    Tidak ada data ditemukan sesuai filter.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <div className="bg-slate-50 px-6 py-4 border-t border-slate-100 text-xs text-slate-500 flex justify-between items-center">
                                <span>Menampilkan {filteredData.length} dari {data.length} data</span>
                            </div>
                        </Card>
                    </div>
                )
            }

            // --- Logic Tampilan Kepemilikan (Barang) ---
            const renderOwnershipView = () => {
                const filledNiups = new Set(barangData.map(b => String(b.niup)));
                
                const missingData = santriData.filter(s => !filledNiups.has(String(s.niup)));
                const filledData = barangData; 

                const openForm = (data, mode) => {
                    setEditBarangData(data);
                    setShowBarangModal(true);
                };

                return (
                    <TableView 
                        title="Data Kepemilikan"
                        data={ownershipTab === 'missing' ? missingData : filledData}
                        onAdd={null} 
                        extraHeader={
                            <div className="flex space-x-1 bg-slate-100 p-1 rounded-xl w-fit">
                                <button 
                                    onClick={() => setOwnershipTab('missing')}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                        ownershipTab === 'missing' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    Belum Diisi ({missingData.length})
                                </button>
                                <button 
                                    onClick={() => setOwnershipTab('filled')}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                        ownershipTab === 'filled' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    Sudah Diisi ({filledData.length})
                                </button>
                            </div>
                        }
                        columns={ownershipTab === 'missing' ? [
                            { header: 'NIUP', accessor: 'niup' },
                            { header: 'Nama', accessor: 'nama' },
                            { header: 'Kamar', accessor: 'kamar' },
                            { header: 'Kelas', accessor: 'kelas' },
                            { header: 'Aksi', render: (row) => (
                                <Button variant="info" className="py-1 px-3 text-xs" onClick={() => openForm(row, 'create')}>
                                    <UserPlus className="w-3 h-3" /> Input
                                </Button>
                            )}
                        ] : [
                            { header: 'NIUP', accessor: 'niup' },
                            { header: 'Nama', accessor: 'nama' },
                            { header: 'Kitab', render: (row) => (
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${row.kepemilikan === 'Ya' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {row.kepemilikan}
                                </span>
                            )},
                            { header: 'Rekapitulasi', render: (row) => (
                                <span className="font-bold text-emerald-600">{row.rekapitulasi}</span>
                            )},
                            { header: 'Aksi', render: (row) => (
                                <div className="flex gap-2">
                                    <Button variant="secondary" className="py-1 px-2 text-xs" onClick={() => openForm(row, 'edit')}>
                                        <Edit2 className="w-3 h-3" /> Detail/Edit
                                    </Button>
                                </div>
                            )}
                        ]}
                    />
                );
            };

            const SettingsView = () => (
                <div className="max-w-2xl mx-auto space-y-6 animate-fade-in">
                    <div className="text-center mb-8">
                        <h2 className="text-2xl font-bold text-slate-800">Pengaturan Aplikasi</h2>
                        <p className="text-slate-500">Konfigurasi koneksi database Google Sheets.</p>
                    </div>

                    <Card className="p-8">
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">Google Apps Script Web App URL</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={webAppUrl}
                                        onChange={(e) => setWebAppUrl(e.target.value)}
                                        placeholder="https://script.google.com/macros/s/..."
                                        className="flex-1 px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 outline-none"
                                    />
                                    <Button onClick={() => {
                                        localStorage.setItem('pdk_webapp_url', webAppUrl);
                                        alert("URL tersimpan!");
                                    }}>
                                        <Save className="w-4 h-4" /> Simpan
                                    </Button>
                                </div>
                            </div>

                            <div className="border-t border-slate-100 pt-6">
                                <h4 className="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                                    <Activity className="w-4 h-4 text-slate-500" />
                                    Status Koneksi
                                </h4>
                                <div className="flex items-center justify-between bg-slate-50 p-4 rounded-xl">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                                            connectionStatus === 'success' ? 'bg-green-100 text-green-600' : 
                                            connectionStatus === 'error' ? 'bg-red-100 text-red-600' :
                                            'bg-slate-200 text-slate-500'
                                        }`}>
                                            {connectionStatus === 'success' ? <Wifi className="w-5 h-5" /> : 
                                            connectionStatus === 'error' ? <WifiOff className="w-5 h-5" /> :
                                            <Activity className="w-5 h-5" />}
                                        </div>
                                        <div>
                                            <p className="text-sm font-medium text-slate-900">
                                                {connectionStatus === 'success' ? 'Terhubung' : 
                                                connectionStatus === 'error' ? 'Gagal Terhubung' : 
                                                connectionStatus === 'testing' ? 'Sedang mengecek...' :
                                                'Belum dicek'}
                                            </p>
                                            <p className="text-xs text-slate-500">
                                                {connectionStatus === 'success' ? 'Siap mengirim data.' : 
                                                'Klik tombol di kanan untuk tes.'}
                                            </p>
                                        </div>
                                    </div>
                                    <Button 
                                        variant={connectionStatus === 'success' ? 'success' : 'secondary'} 
                                        onClick={testConnection} 
                                        disabled={connectionStatus === 'testing'}
                                    >
                                        {connectionStatus === 'testing' ? 'Loading...' : 'Tes Koneksi'}
                                    </Button>
                                </div>
                            </div>
                            
                            <p className="text-xs text-slate-500 bg-slate-50 p-4 rounded-lg leading-relaxed mt-4">
                                <strong>Catatan:</strong><br/>
                                Jika Tes Koneksi gagal (Error CORS), bukan berarti aplikasi rusak. Google sering memblokir "Test/Ping" dari browser langsung. Coba simpan data santri; jika berhasil, maka aplikasi berjalan normal.
                            </p>
                        </div>
                    </Card>
                </div>
            )

            // --- Main Layout Render ---

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">
                {/* Sidebar */}
                <aside className={`bg-white border-r border-slate-200 flex flex-col transition-all duration-300 z-20 ${isSidebarOpen ? 'w-64' : 'w-20'} fixed h-full md:relative`}>
                    <div className="h-20 flex items-center justify-center border-b border-slate-100">
                        <div className={`flex items-center gap-3 ${!isSidebarOpen && 'justify-center'}`}>
                            <div className="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-emerald-200">
                                PDK
                            </div>
                            {isSidebarOpen && <span className="font-bold text-xl tracking-tight text-emerald-950">PDK System</span>}
                        </div>
                    </div>

                    <nav className="flex-1 py-6 px-3 space-y-2 overflow-y-auto">
                        {[
                            { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
                            { id: 'santri', label: 'Data Santri', icon: Users },
                            { id: 'barang', label: 'Kepemilikan', icon: BookOpen },
                            { id: 'settings', label: 'Pengaturan', icon: Settings },
                        ].map(item => (
                            <button 
                                key={item.id}
                                onClick={() => { setView(item.id); if(window.innerWidth < 768) setIsSidebarOpen(false); }}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                                    view === item.id 
                                    ? 'bg-emerald-50 text-emerald-700 font-semibold shadow-sm' 
                                    : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                                } ${!isSidebarOpen && 'justify-center px-2'}`}
                            >
                                <item.icon className="w-5 h-5" />
                                {isSidebarOpen && <span>{item.label}</span>}
                            </button>
                        ))}
                    </nav>

                    <div className="p-4 border-t border-slate-100">
                        <button 
                            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                            className="w-full flex items-center justify-center p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-50 rounded-lg transition"
                        >
                            {isSidebarOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
                        </button>
                    </div>
                </aside>

                {/* Main Content */}
                <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                    {/* Header Mobile */}
                    <header className="md:hidden h-16 bg-white border-b border-slate-200 flex items-center px-4 justify-between">
                        <span className="font-bold text-lg text-emerald-800">PDK System</span>
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 text-slate-600">
                            <Menu className="w-6 h-6" />
                        </button>
                    </header>

                    <div className="flex-1 overflow-y-auto p-4 md:p-8 relative">
                        {view === 'dashboard' && <Dashboard />}
                        
                        {view === 'santri' && (
                            <TableView 
                                title="Data Santri"
                                data={santriData}
                                onAdd={() => setShowSantriModal(true)}
                                columns={[
                                    { header: 'NIUP', accessor: 'niup' },
                                    { header: 'Nama', accessor: 'nama' },
                                    { header: 'Kamar', accessor: 'kamar' },
                                    { header: 'Kelas', accessor: 'kelas' },
                                    { header: 'Jenjang', accessor: 'jenjang' },
                                    { header: 'Wilayah', accessor: 'wilayah' },
                                ]}
                            />
                        )}

                        {view === 'barang' && renderOwnershipView()}

                        {view === 'settings' && <SettingsView />}
                    </div>
                </main>

                {/* Modals */}
                {showSantriModal && <SantriForm onClose={() => setShowSantriModal(false)} />}
                {showBarangModal && <BarangForm onClose={() => setShowBarangModal(false)} initialData={editBarangData} />}
                </div>
            );
        }

        // Initialize App
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>